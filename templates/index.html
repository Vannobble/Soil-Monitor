<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Moisture Monitor - Real Time</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS sebelumnya... */
        
        .auto-update-status {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 0.8rem;
        }
        
        .auto-update-status.active {
            background: rgba(107, 207, 127, 0.3);
            color: #6bcf7f;
        }
        
        .last-update-time {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .connection-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-wifi"></i> üî¥ Disconnected
        <span class="auto-update-status" id="autoUpdateStatus">Manual</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üå± Soil Moisture Monitor</h1>
            <p>Real-time monitoring sistem kelembaban tanah dengan enkripsi ASCON</p>
            <div class="deployment-info">
                <span class="server-status offline" id="serverStatus"></span>
                Server: <span id="serverUrl">Loading...</span>
            </div>
            <div class="connection-stats">
                <div class="stat-item">
                    <i class="fas fa-sync"></i> Auto-Update: <span id="updateMode">OFF</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-clock"></i> Last Data: <span id="lastDataTime">Never</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-database"></i> Total: <span id="totalMessages">0</span>
                </div>
            </div>
        </div>

        <!-- Konten dashboard sama seperti sebelumnya -->
        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-tint"></i> Status Kelembaban Tanah</h2>
                <div class="moisture-level">
                    <div class="percentage" id="moisturePercentage">0%</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%;">
                            <span class="progress-text" id="progressText">0%</span>
                        </div>
                    </div>
                    <div class="status" id="statusText">
                        <i class="fas fa-sync fa-spin"></i> Menunggu koneksi...
                    </div>
                    <div class="last-update-time">
                        <i class="fas fa-clock"></i> Update: <span id="updateTime">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-microchip"></i> Informasi Sensor</h2>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">Sensor Type</div>
                        <div class="data-value" id="sensorType">-</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Unit</div>
                        <div class="data-value" id="sensorUnit">-</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Messages</div>
                        <div class="data-value" id="messageCount">0</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Connection</div>
                        <div class="data-value" id="connectionType">-</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-shield-alt"></i> Security Info</h2>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">Encryption</div>
                        <div class="data-value">ASCON-128</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Status</div>
                        <div class="data-value" id="encryptionStatus">Active</div>
                    </div>
                </div>
                <div class="data-label" style="margin-top: 15px;">Cipher Text:</div>
                <div class="encrypted-data" id="cipherText">
                    <i class="fas fa-lock"></i> Menunggu data...
                </div>
                <button id="requestDataBtn" style="margin-top: 10px; padding: 8px 15px; background: #4a90e2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-sync"></i> Request Data Now
                </button>
            </div>
        </div>

        <div class="chart-container">
            <h2><i class="fas fa-chart-line"></i> Riwayat Kelembaban (Real-time)</h2>
            <canvas id="moistureChart"></canvas>
        </div>

        <div class="last-update">
            <i class="fas fa-clock"></i> System started: <span id="systemStartTime"></span> |
            <i class="fas fa-globe"></i> Environment: <span id="environment">Production</span> |
            <i class="fas fa-plug"></i> Connection: <span id="connectionInfo">Disconnected</span>
        </div>
    </div>

    <script>
        // Konfigurasi untuk production
        const config = {
            serverUrl: window.location.origin,
            reconnectInterval: 3000,
            maxReconnectAttempts: 5,
            autoReconnect: true
        };

        // Variabel global
        let moistureData = [];
        let maxDataPoints = 20;
        let chart = null;
        let socket = null;
        let reconnectAttempts = 0;
        let isConnected = false;
        let lastUpdateTimestamp = null;

        // Elemen DOM
        const connectionStatus = document.getElementById('connectionStatus');
        const moisturePercentage = document.getElementById('moisturePercentage');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusText = document.getElementById('statusText');
        const sensorType = document.getElementById('sensorType');
        const sensorUnit = document.getElementById('sensorUnit');
        const messageCountElement = document.getElementById('messageCount');
        const cipherText = document.getElementById('cipherText');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        const systemStartTime = document.getElementById('systemStartTime');
        const serverUrl = document.getElementById('serverUrl');
        const serverStatus = document.getElementById('serverStatus');
        const environment = document.getElementById('environment');
        const autoUpdateStatus = document.getElementById('autoUpdateStatus');
        const updateMode = document.getElementById('updateMode');
        const lastDataTime = document.getElementById('lastDataTime');
        const totalMessages = document.getElementById('totalMessages');
        const updateTime = document.getElementById('updateTime');
        const connectionType = document.getElementById('connectionType');
        const connectionInfo = document.getElementById('connectionInfo');
        const requestDataBtn = document.getElementById('requestDataBtn');

        // Inisialisasi Chart
        function initializeChart() {
            const ctx = document.getElementById('moistureChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Kelembaban Tanah (%)',
                        data: [],
                        borderColor: '#4a90e2',
                        backgroundColor: 'rgba(74, 144, 226, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#4a90e2',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Kelembaban: ${context.parsed.y}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Koneksi Socket.IO dengan reconnection logic
        function connectSocket() {
            console.log(`üîÑ Connecting to server: ${config.serverUrl}`);
            serverUrl.textContent = config.serverUrl;
            
            socket = io(config.serverUrl, {
                transports: ['websocket', 'polling'],
                timeout: 10000,
                reconnection: config.autoReconnect,
                reconnectionAttempts: config.maxReconnectAttempts,
                reconnectionDelay: config.reconnectInterval
            });

            socket.on('connect', function() {
                console.log('‚úÖ Connected to server via Socket.IO');
                isConnected = true;
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> üü¢ Connected (WebSocket)';
                connectionStatus.className = 'connection-status connected';
                autoUpdateStatus.textContent = 'Auto';
                autoUpdateStatus.className = 'auto-update-status active';
                updateMode.textContent = 'ON';
                serverStatus.className = 'server-status online';
                connectionType.textContent = 'WebSocket';
                connectionInfo.textContent = 'WebSocket Live';
                reconnectAttempts = 0;
                
                // Request data terbaru saat pertama connect
                socket.emit('request_data');
            });

            socket.on('sensor_data', function(data) {
                console.log('üì® Received real-time sensor data:', data);
                lastUpdateTimestamp = new Date();
                updateUI(data);
            });

            socket.on('disconnect', function(reason) {
                console.log('‚ùå Disconnected from server:', reason);
                isConnected = false;
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> üî¥ Disconnected';
                connectionStatus.className = 'connection-status disconnected';
                autoUpdateStatus.textContent = 'Manual';
                autoUpdateStatus.className = 'auto-update-status';
                updateMode.textContent = 'OFF';
                serverStatus.className = 'server-status offline';
                connectionType.textContent = 'Disconnected';
                connectionInfo.textContent = 'Disconnected';
                
                if (reason === 'io server disconnect') {
                    // Server memutus koneksi, reconnect
                    socket.connect();
                }
            });

            socket.on('connect_error', function(error) {
                console.error('‚ùå Socket.IO connection error:', error);
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> üî¥ Connection Error';
                connectionStatus.className = 'connection-status disconnected';
                serverStatus.className = 'server-status offline';
                connectionInfo.textContent = 'Connection Error';
            });

            socket.on('reconnect_attempt', function(attempt) {
                console.log(`üîÑ Reconnection attempt ${attempt}`);
                connectionStatus.innerHTML = `<i class="fas fa-sync fa-spin"></i> üîÑ Reconnecting... (${attempt})`;
            });

            socket.on('reconnect', function(attempt) {
                console.log(`‚úÖ Reconnected after ${attempt} attempts`);
            });
        }

        // Manual request data
        function requestData() {
            if (socket && isConnected) {
                socket.emit('request_data');
                console.log('üì® Manual data request sent');
                
                // Visual feedback
                requestDataBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Requesting...';
                setTimeout(() => {
                    requestDataBtn.innerHTML = '<i class="fas fa-sync"></i> Request Data Now';
                }, 1000);
            } else {
                console.log('‚ùå Cannot request data: Not connected');
                alert('Tidak terhubung ke server. Silakan refresh halaman.');
            }
        }

        // Update UI dengan data baru
        function updateUI(data) {
            const moistureValue = data.moisture;
            const timestamp = data.timestamp || new Date().toLocaleTimeString('id-ID');
            const now = new Date();

            // Update basic information
            sensorType.textContent = data.sensor;
            sensorUnit.textContent = data.unit;
            messageCountElement.textContent = data.message_count;
            totalMessages.textContent = data.message_count;
            lastDataTime.textContent = timestamp;
            updateTime.textContent = now.toLocaleTimeString('id-ID');
            cipherText.textContent = data.encrypted || 'No data';

            // Update visual components dengan animasi
            updateProgressBar(moistureValue);
            updateStatus(moistureValue);
            updateChart(moistureValue, timestamp);

            // Add pulse animation untuk update baru
            moisturePercentage.classList.add('pulse');
            setTimeout(() => {
                moisturePercentage.classList.remove('pulse');
            }, 1000);

            console.log(`‚úÖ UI updated with moisture: ${moistureValue}%`);
        }

        function updateChart(moistureValue, timestamp) {
            moistureData.push(moistureValue);
            
            if (moistureData.length > maxDataPoints) {
                moistureData.shift();
                chart.data.labels.shift();
            }

            chart.data.labels.push(timestamp);
            chart.data.datasets[0].data = moistureData;
            
            // Smooth update chart
            chart.update('active');
        }

        function updateStatus(moistureValue) {
            statusText.className = 'status ';
            
            if (moistureValue < 20) {
                statusText.classList.add('critical');
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> üö® CRITICAL: TANAH SANGAT KERING!<br><small>üí¶ Perlu penyiraman segera!</small>';
            } else if (moistureValue < 40) {
                statusText.classList.add('warning');
                statusText.innerHTML = '<i class="fas fa-exclamation-circle"></i> ‚ö†Ô∏è WARNING: TANAH KERING<br><small>üíß Pertimbangkan penyiraman</small>';
            } else if (moistureValue < 70) {
                statusText.classList.add('optimal');
                statusText.innerHTML = '<i class="fas fa-check-circle"></i> ‚úÖ Status Optimal<br><small>üå± Kondisi tanah baik</small>';
            } else {
                statusText.classList.add('wet');
                statusText.innerHTML = '<i class="fas fa-exclamation-circle"></i> ‚ö†Ô∏è WARNING: TANAH TERLALU BASAH<br><small>üõë Kurangi penyiraman</small>';
            }
        }

        function updateProgressBar(moistureValue) {
            progressBar.style.width = moistureValue + '%';
            progressText.textContent = moistureValue + '%';
            moisturePercentage.textContent = moistureValue + '%';
            
            if (moistureValue < 20) {
                progressBar.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
            } else if (moistureValue < 40) {
                progressBar.style.background = 'linear-gradient(90deg, #ffd93d, #ffeaa7)';
            } else if (moistureValue < 70) {
                progressBar.style.background = 'linear-gradient(90deg, #6bcf7f, #a8e6cf)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #4d96ff, #6bc5ff)';
            }
        }

        // Event listeners
        requestDataBtn.addEventListener('click', requestData);

        // Inisialisasi
        async function init() {
            systemStartTime.textContent = new Date().toLocaleString('id-ID');
            environment.textContent = window.location.hostname === 'localhost' ? 'Development' : 'Production';
            
            initializeChart();
            connectSocket();
            
            console.log('üöÄ Soil Moisture Monitor initialized with real-time updates');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
